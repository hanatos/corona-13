/*
    This file is part of corona-13.

    corona-13 is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    corona-13 is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with corona-13. If not, see <http://www.gnu.org/licenses/>.
*/

#include "corona_common.h"
#include "sampler_common.h"
#include "shader.h"
#include "spectrum.h"
#include "prims.h"

#if 0
LGOROWLENGTH	4
CREATED	"2006/06/04"  # Time: 22:45
INSTRUMENTATION	"BabelColor_Avg20"
MEASUREMENT_SOURCE	"Illumination=Unknown	ObserverAngle=Unknown	WhiteBase=Abs	Filter=Unknown"
ILLUMINATION_NAME	"D50"
OBSERVER_ANGLE	"2"
KEYWORD	"SampleID"
KEYWORD	"SAMPLE_NAME"
NUMBER_OF_FIELDS	36
BEGIN_DATA_FORMAT
SampleID	SAMPLE_NAME	nm380	nm390	nm400	nm410	nm420	nm430	nm440	nm450	nm460	nm470	nm480	nm490	nm500	nm510	nm520	nm530	nm540	nm550	nm560	nm570	nm580	nm590	nm600	nm610	nm620	nm630	nm640	nm650	nm660	nm670	nm680	nm690	nm700	nm710	nm720	nm730
END_DATA_FORMAT
NUMBER_OF_SETS	24
BEGIN_DATA
#endif

const int SLOT_DIFFUSE = 0;
const int SLOT_SPECULAR = 1;
const int SLOT_EMISSION = 2;
const int SLOT_VOLUME = 3;
const int SLOT_GLOSSY = 4;
const int SLOT_ROUGHNESS = 5;

typedef struct cobs_t
{
  int slot;
  float roughness;
}
cobs_t;

static const float lambda_min  = 380.0f;
static const float lambda_step = 10.0f;
static const int   lambda_num  = 36;
static const float cobs[24][36] = {
//1	A1
  {0.054928165,	0.0581961975,	0.0609521425,	0.0622061525,	0.0620531275,	0.0617160425,	0.0613158025,	0.0608955775,	0.060749115,	0.0608631725,	0.0613578675,	0.06239833,	0.06468821,	0.06966569,	0.0756103175,	0.078634005,	0.080475245,	0.0836333475,	0.0900135575,	0.1024371125,	0.1185485,	0.1337043625,	0.143039425,	0.1472021375,	0.151195,	0.1582548875,	0.168002025,	0.1787124,	0.187641475,	0.19021595,	0.1875647625,	0.1846605375,	0.18550555,	0.19160065,	0.200458775,	0.21374455},
//2	A2
  {0.05309449, 0.052864805, 0.052597875, 0.0531177525, 0.0534208225, 0.0539375975, 0.054314285, 0.054315305, 0.0547081275, 0.055737855, 0.05764311, 0.0603919975, 0.06739489, 0.08843009, 0.1225087275, 0.15074655, 0.1724077, 0.2000098, 0.250099, 0.3381320125, 0.4452105875, 0.5361048625, 0.582677075, 0.5904485, 0.5859682, 0.5818492375, 0.5792004875, 0.57883, 0.5839088625, 0.5947242, 0.6107983875, 0.6281783, 0.644307875, 0.6527636375, 0.65409565, 0.6592294375},
//3	A3
  {0.06445819, 0.0739102275, 0.09356403, 0.1379836875, 0.192345875, 0.2388256, 0.2802546875, 0.3111746625, 0.311984, 0.2813770625, 0.2314083875, 0.1753257, 0.126106225, 0.0902293375, 0.0660259925, 0.0517230975, 0.04457038, 0.04110103, 0.0394093425, 0.03847107, 0.0379463475, 0.0379817875, 0.03823817, 0.03883675, 0.039527915, 0.0397540025, 0.04007707, 0.04091059, 0.0420560175, 0.0429022375, 0.0431814475, 0.043400665, 0.0443291125, 0.0465988125, 0.0498460325, 0.0553992675},
//4	A4
  {0.198909325, 0.2591946375, 0.4206278, 0.659731925, 0.811365, 0.8631002625, 0.877124075, 0.883973925, 0.88968365, 0.8937990875, 0.8969956125, 0.900978975, 0.9047299875, 0.906422675, 0.908175075, 0.9068361875, 0.907147425, 0.9098939375, 0.9095236125, 0.912152075, 0.9118310375, 0.9120487625, 0.9102492875, 0.911925225, 0.9147864, 0.916091025, 0.9184446375, 0.9199876875, 0.921025625, 0.9195902675, 0.9205984625, 0.9232510625, 0.9259472625, 0.92828135, 0.928888375, 0.9318229625},
//5	B1
  {0.121190415, 0.1481413, 0.1800520875, 0.1969142125, 0.2013126875, 0.20396945, 0.2081829, 0.21589835, 0.229348975, 0.2500339, 0.276596775, 0.3043041375, 0.3252363875, 0.330120175, 0.3143509, 0.2893365, 0.277465975, 0.279229125, 0.2799079, 0.2935426875, 0.34393545, 0.4235676, 0.4887537, 0.5231027875, 0.5423739, 0.558449625, 0.575687125, 0.5938128125, 0.611100875, 0.6228164625, 0.6342885875, 0.650544325, 0.672105475, 0.692824975, 0.7101270875, 0.7276644},
//6	B2
  {0.1316293875, 0.171463575, 0.23288145, 0.2898174625, 0.32928895, 0.3617175125, 0.387262025, 0.398598825, 0.3896286125, 0.3592335375, 0.31250655, 0.2572369625, 0.2065176625, 0.1670657, 0.1373065125, 0.1167969, 0.10457155, 0.096682815, 0.09019641, 0.08579616, 0.083713535, 0.0836673425, 0.0838220925, 0.083519125, 0.0832590525, 0.08427768, 0.0881273575, 0.095153425, 0.104810175, 0.1167203125, 0.1326185875, 0.155092375, 0.1859365875, 0.2184519125, 0.25548595, 0.296241175},
//7	B3
  {0.0514518775, 0.0526747175, 0.05406222, 0.055431835, 0.056888345, 0.05873269, 0.0615423575, 0.0656096625, 0.0743337, 0.0918667325, 0.1233903375, 0.1761763875, 0.2440002375, 0.3064041625, 0.33776955, 0.3337457375, 0.31606755, 0.292506275, 0.2607001, 0.2280667375, 0.1959985125, 0.164144125, 0.1342701125, 0.113925075, 0.102491145, 0.0958334675, 0.0918724075, 0.08950145, 0.089622905, 0.093107505, 0.098596845, 0.10406233, 0.108731635, 0.110737835, 0.1097938475, 0.1102011475},
//8	B4
  {0.182196625, 0.2401416125, 0.3672066375, 0.5062115875, 0.566115625, 0.581326375, 0.5856345625, 0.5874476875, 0.58795455, 0.58671525, 0.5853317625, 0.5852525625, 0.58596545, 0.586253825, 0.587231375, 0.5863258125, 0.585857025, 0.586365375, 0.5854909875, 0.5870729, 0.5866217, 0.5861026625, 0.5835444, 0.581895125, 0.58016655, 0.5772111125, 0.5750412125, 0.5732196, 0.57184755, 0.5698095875, 0.56853135, 0.5675080375, 0.5666064875, 0.5666655, 0.5653437625, 0.5653271125},
//9	C1
  {0.1408027875, 0.184342075, 0.2538563625, 0.306987625, 0.32456425, 0.331074825, 0.3344096625, 0.3332864, 0.3265039125, 0.314477075, 0.300347975, 0.2868459, 0.2711593625, 0.2512669875, 0.231410225, 0.2147983375, 0.2002475875, 0.1837834625, 0.16714445, 0.1558103875, 0.15015155, 0.14741345, 0.14395485, 0.1413361, 0.140363975, 0.1401738875, 0.1413327375, 0.1449158875, 0.1495279125, 0.1506371125, 0.147176025, 0.1413317375, 0.13417855, 0.1309976675, 0.1333576625, 0.143823815},
//10	C2
  {0.0983254225, 0.116366, 0.13125065, 0.135560175, 0.1340186375, 0.1323836625, 0.131113325, 0.1289768375, 0.1259172, 0.12143125, 0.116007675, 0.110565225, 0.1056612875, 0.1005252525, 0.0957681075, 0.093175555, 0.0929999075, 0.0936968575, 0.09701407, 0.1094840125, 0.1571848125, 0.2678956125, 0.4011753, 0.5009097125, 0.55667015, 0.579205975, 0.586832, 0.5894345375, 0.5917154875, 0.59503015, 0.6006267375, 0.6073597125, 0.61396335, 0.6170001625, 0.6165873, 0.618122125},
// 11	C3
  {0.0489968375, 0.0481228625, 0.0469747425, 0.0467057875, 0.046642665, 0.0469211575, 0.04699569, 0.0463287, 0.04540421, 0.0446408775, 0.044026965, 0.04394508, 0.04422173, 0.04451257, 0.04507332, 0.04571009, 0.0466908025, 0.04855438, 0.05212227, 0.0578214525, 0.0705426225, 0.1030997975, 0.1771919625, 0.3134665375, 0.4706368125, 0.5856703375, 0.6508527875, 0.68220215, 0.6981527925, 0.7069727625, 0.7152823, 0.7248441625, 0.7338653, 0.7401174875, 0.7435055125, 0.74826765},
// 12	C4
  {0.1517603, 0.196730675, 0.2718882875, 0.3295891625, 0.3493042875, 0.3559309625, 0.3597271, 0.361264675, 0.3607481625, 0.3586315375, 0.3566101, 0.35593265, 0.3563589375, 0.3569175125, 0.35800045, 0.3577902375, 0.35765735, 0.358016025, 0.3577668875, 0.359185725, 0.359203925, 0.3588771875, 0.356998725, 0.3555223875, 0.35378935, 0.3508849875, 0.3483832375, 0.346176575, 0.3441421875, 0.3414889625, 0.33912365, 0.3367361, 0.3344211875, 0.33327365, 0.331418125, 0.3302426625},
// 13	D1
  {0.050884935, 0.053654015, 0.0552763975, 0.0564082975, 0.0574153275, 0.058832145, 0.0604676275, 0.061553075, 0.062485825, 0.063456105, 0.0650796525, 0.067661345, 0.075945205, 0.1025927625, 0.1458191125, 0.177201825, 0.1831246375, 0.1695380875, 0.14874935, 0.1322822, 0.1213745875, 0.1144551625, 0.10860855, 0.1044534875, 0.10331322, 0.1044688125, 0.106616525, 0.1090360725, 0.1109728375, 0.111131025, 0.11068555, 0.112284775, 0.1168485, 0.1234561375, 0.1290771375, 0.135006825},
// 14	D2
  {0.0953400425, 0.1188469625, 0.1480212375, 0.1722601625, 0.182265775, 0.17607805, 0.1597569, 0.139152875, 0.1184431875, 0.10012615, 0.0854355425, 0.073834965, 0.06506045, 0.05935926, 0.0555969925, 0.052515415, 0.05085158, 0.0510143725, 0.05177128, 0.051774775, 0.051376195, 0.0528320175, 0.0587343, 0.073104305, 0.09464589, 0.117076, 0.138652225, 0.1619828, 0.189352725, 0.2205586625, 0.2560135625, 0.2953240625, 0.3358838125, 0.36974065, 0.4043541375, 0.44543255},
// 15	D3
  {0.0558930725, 0.0525581225, 0.0515135775, 0.05158528, 0.052325125, 0.0538493425, 0.0560144025, 0.0591833675, 0.0662762075, 0.08072704, 0.1078783825, 0.15431075, 0.228219625, 0.33919845, 0.4641712625, 0.557247325, 0.6129752125, 0.6469570875, 0.66972385, 0.691849875, 0.7085303625, 0.72207475, 0.730548625, 0.7390039125, 0.746933725, 0.752527225, 0.7585272625, 0.7639783, 0.768821625, 0.7716117375, 0.7767926375, 0.784096625, 0.7919629875, 0.7977666625, 0.8007108125, 0.8051519},
// 16	D4
  {0.1086666825, 0.133326575, 0.1631274, 0.180763025, 0.1868017875, 0.19063125, 0.19381625, 0.1948354125, 0.1942155625, 0.192839175, 0.1916371, 0.1915384375, 0.1920665375, 0.1922014875, 0.19245375, 0.1923047875, 0.192232075, 0.1924080625, 0.19213175, 0.192474825, 0.1919877625, 0.1913891125, 0.190040125, 0.189093775, 0.1879590125, 0.185884625, 0.183936825, 0.1822301, 0.1808359375, 0.179399925, 0.1781677875, 0.17656065, 0.174757125, 0.1739794375, 0.17288235, 0.1721216875},
// 17	E1
  {0.1582015125, 0.2086562, 0.3001288125, 0.3796227875, 0.412229225, 0.424513225, 0.429127325, 0.428517925, 0.4215125375, 0.4053804875, 0.3808760375, 0.34784605, 0.312720975, 0.2823231875, 0.254234525, 0.2287687375, 0.2137224625, 0.2080051625, 0.2017455, 0.19496295, 0.1935935125, 0.2016757375, 0.215954325, 0.2305049125, 0.2407154125, 0.25281645, 0.2759688625, 0.31029445, 0.3454413375, 0.3648525875, 0.3673499125, 0.3631766875, 0.361778375, 0.367686775, 0.3774999, 0.3944604},
// 18	E2
  {0.060108325, 0.0608860375, 0.0621687175, 0.0634401275, 0.0644554075, 0.0664809175, 0.0697920825, 0.0750919925, 0.085532575, 0.1044059, 0.1370521875, 0.19009565, 0.26913515, 0.3765805875, 0.478237025, 0.5334623, 0.5507542375, 0.5468944125, 0.528741125, 0.5047195375, 0.470575625, 0.4272058625, 0.3805316125, 0.3464065625, 0.326996525, 0.3170198, 0.3116849875, 0.30910435, 0.31357005, 0.326538025, 0.344508975, 0.3620780375, 0.3761405375, 0.3804993375, 0.3779309, 0.3798554},
// 19	E3
  {0.1546604375, 0.2023284875, 0.2843727625, 0.3456731625, 0.3616991, 0.3545795375, 0.3337976375, 0.305361825, 0.2753375, 0.2464537375, 0.2169912875, 0.1890735875, 0.1670896125, 0.147691625, 0.1258400125, 0.1067495375, 0.099213475, 0.1011588875, 0.1030486125, 0.1088204625, 0.1363376625, 0.1994422875, 0.2901450375, 0.3995447125, 0.51404145, 0.6113105875, 0.6818817625, 0.7262401875, 0.754120625, 0.7690867125, 0.77862885, 0.788734925, 0.79962455, 0.8073034625, 0.8126254125, 0.82136125},
// 20	E4
  {0.06805148, 0.0763794375, 0.082989665, 0.0864448475, 0.088084395, 0.0897857625, 0.0912298125, 0.0912621725, 0.090480235, 0.0895695075, 0.089018825, 0.089030365, 0.0892959625, 0.08926015, 0.0892361525, 0.0891961275, 0.0892535925, 0.0894205525, 0.0892730975, 0.0892221725, 0.0887364, 0.08836738, 0.0877758625, 0.08749558, 0.087100785, 0.0860244525, 0.084994025, 0.0842447975, 0.083701365, 0.0833122925, 0.0829867625, 0.0823219425, 0.0814167175, 0.08116111, 0.0806740325, 0.0804810175},
// 21	F1
  {0.145328926666667, 0.18546118, 0.249940605263158, 0.299415486842105, 0.32305375, 0.339699171052632, 0.357762315789474, 0.383281368421053, 0.420232934210526, 0.465666868421053, 0.509208473684211, 0.544569355263158, 0.567172144736842, 0.575102065789474, 0.570885644736842, 0.552694368421053, 0.524454802631579, 0.487727302631579, 0.443229631578947, 0.397714197368421, 0.349114631578947, 0.29908425, 0.253092131578947, 0.222632973684211, 0.206224644736842, 0.197500302631579, 0.192442105263158, 0.189729171052632, 0.192019460526316, 0.200311184210526, 0.212003828947368, 0.222958210526316, 0.231182118421053, 0.23275308, 0.229077666666667, 0.228956933333333},
// 22	F2
  {0.062335675, 0.06232948, 0.06345921, 0.0635653725, 0.06368807, 0.06453294, 0.065602595, 0.066100235, 0.067007505, 0.068680005, 0.072127625, 0.077057405, 0.0895881425, 0.1292426875, 0.2081013375, 0.302746925, 0.377830825, 0.4263123125, 0.4678173625, 0.5214019125, 0.57467965, 0.6128037875, 0.630978175, 0.636670725, 0.6371764125, 0.6381893125, 0.641384725, 0.643569925, 0.645882625, 0.647769, 0.6525957, 0.6605271125, 0.6709208375, 0.6791632125, 0.683698125, 0.68879635},
// 23	F3
  {0.113870125, 0.1446352, 0.1921882125, 0.234629425, 0.25917835, 0.2841570125, 0.3160403875, 0.352066475, 0.389555975, 0.4257197375, 0.4459086375, 0.4443337625, 0.422875975, 0.38405535, 0.3346286125, 0.2802795125, 0.228590225, 0.1826380375, 0.1436142125, 0.116728325, 0.09955418, 0.0887121175, 0.0808411725, 0.07592825, 0.0737505625, 0.0727821925, 0.0726591925, 0.0734195825, 0.07504005, 0.076154135, 0.0759558875, 0.0745718725, 0.0723498375, 0.0717199475, 0.07334494, 0.07861636},
// 24	F4
  {0.0311182725, 0.0318181475, 0.0321338325, 0.032362505, 0.03257239, 0.0326591625, 0.032683825, 0.0324634425, 0.03224281, 0.0321773425, 0.0321214425, 0.0321086675, 0.0320948825, 0.0319342975, 0.0318325025, 0.031701825, 0.0316719775, 0.0316950425, 0.031657465, 0.031661225, 0.03149601, 0.0314663375, 0.031399645, 0.031550025, 0.031665245, 0.0316251775, 0.0316034575, 0.031614725, 0.0316994325, 0.0318400875, 0.031998465, 0.0319964775, 0.0319917375, 0.03207163, 0.03210595, 0.032210715}
};
// END_DATA

static inline float get_spectrum(int i, float lambda)
{
  int l = (lambda - lambda_min)/lambda_step;
  if(l < 0 || l >= lambda_num) return 0.0f;
  return cobs[i][l];
}

extern int init(FILE *s, void **data)
{
  cobs_t *t = (cobs_t *)malloc(sizeof(cobs_t));
  *data = t;
  char c;
  t->slot = SLOT_DIFFUSE;
  t->roughness = 1.0f; // cos^1
  if(fscanf(s, " %c %f", &c, &t->roughness) < 1)
  {
    fprintf(stderr, "[cobs] could not read parameters! expecting: [dgsevr] [roughness]\n");
    return 1;
  }
  int dreggn = fscanf(s, "%*[^\n]\n");
  if(c == 'd') t->slot = SLOT_DIFFUSE;
  else if(c == 's') t->slot = SLOT_SPECULAR;
  else if(c == 'e') t->slot = SLOT_EMISSION;
  else if(c == 'v') t->slot = SLOT_VOLUME;
  else if(c == 'g') t->slot = SLOT_GLOSSY;
  else if(c == 'r') t->slot = SLOT_ROUGHNESS;
  else fprintf(stderr, "[cobs] got wrong color slot `%c' using diffuse instead\n", c);
  return dreggn == -1;
}

// extern void cleanup(void *data) { } // std cleanup: free()

float emission(float *roughness, float *em, const float lambda, void *data)
{
  cobs_t *c = (cobs_t *)data;

  if(c->slot == SLOT_EMISSION)
  {
    *roughness = c->roughness;
    return .3333f; // will result in terrible importance sampling.
  }
  else
  {
    *em = 0.0f;
    return 0.0f;
  }
}

float prepare(path_t *p, int vi, void *data)
{
  cobs_t *c = (cobs_t *)data;
  const float u = p->v[vi].hit.s;
  const float v = p->v[vi].hit.t;

  // get cobs index from uv, or gray for bg
  int i, j;
  i = (int)(6.0f*u) % 6;
  j = (int)(4.0f*v) % 4;

  float *slot = &p->v[vi].shading.rd;
  if(c->slot != SLOT_ROUGHNESS)
    p->v[vi].shading.roughness = c->roughness;
  if     (c->slot == SLOT_SPECULAR) slot = &p->v[vi].shading.rs;
  else if(c->slot == SLOT_EMISSION) slot = &p->v[vi].shading.em;
  else if(c->slot == SLOT_VOLUME)  {slot = &p->v[vi].interior.mu_s; p->v[vi].interior.mu_t = 1.0f; }
  else if(c->slot == SLOT_GLOSSY)   slot = &p->v[vi].shading.rg;
  else if(c->slot == SLOT_ROUGHNESS)slot = &p->v[vi].shading.roughness;

  if(fmodf(6.0f*u, 1.0f) < 0.1f || fmodf(6.0f*u, 1.0f) > 0.9f || fmodf(4.0f*v, 1.0f) < 0.1f || fmodf(4.0f*v, 1.0f) > 0.9f) *slot = 0.3f;
  else *slot = get_spectrum(6*j + i, p->lambda);
  return 1.0f;
}

