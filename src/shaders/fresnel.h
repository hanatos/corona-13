#pragma once
#ifndef __cplusplus
#include <complex.h>
#else
#include <complex>
#endif
#include <strings.h>

// some material constants for metals:
typedef enum fresnel_ior_t
{
  s_ior_Ti = 0,
  s_ior_Cu,
  s_ior_Fe,
  s_ior_Au,
  s_ior_Ag,
  s_ior_num_materials
}
fresnel_ior_t;

static const char *fresnel_ior_material[] =
{
  "Ti", "Cu", "Fe", "Au", "Ag"
};

// titanium
static const float fresnel_ior[][95][2] =
{
// Ti
{
  {1.85437486303224, 2.88289057363709},
  {1.88340871633106, 2.89377826862415},
  {1.91420803014971, 2.9047360100499},
  {1.94771858974772, 2.91590619658257},
  {1.9803472925142 , 2.92678243083806},
  {2.01042630446848, 2.93453917877077},
  {2.03901058261632, 2.9408912405814},
  {2.06687120815282, 2.94708249070063},
  {2.09013661859232, 2.95506830929616},
  {2.10927073441217, 2.96463536720609},
  {2.12793816448032, 2.97396908224016},
  {2.14718173978253, 2.98307788847823},
  {2.16792957621369, 2.9919698183773},
  {2.18818922825824, 3.00065252639639},
  {2.20797772560407, 3.00913331097317},
  {2.22369686458765, 3.01684843229382},
  {2.23864611350405, 3.02432305675202},
  {2.25325942424255, 3.03162971212127},
  {2.26754799474242, 3.03877399737121},
  {2.28040228468302, 3.05248274161963},
  {2.29274392651618, 3.06729271181941},
  {2.30482015669701, 3.08178418803641},
  {2.31663944581016, 3.09596733497219},
  {2.32606270113286, 3.11364107754894},
  {2.33442903517555, 3.13246532914499},
  {2.3426228674854 , 3.15090145184215},
  {2.3506494787277 , 3.16896132713732},
  {2.35851393620753, 3.18665635646694},
  {2.37347905983181, 3.20853370726874},
  {2.38984725395889, 3.23103997419347},
  {2.40589450310308, 3.25310494176674},
  {2.42163015517652, 3.27474146336771},
  {2.43706319855623, 3.29596189801481},
  {2.45525284900613, 3.31982870370796},
  {2.47381964602808, 3.3439655398365},
  {2.49203940011504, 3.36765122014956},
  {2.50992175134855, 3.39089827675311},
  {2.52747598604566, 3.41371878185935},
  {2.54260919849555, 3.43652299623886},
  {2.55198278159988, 3.45995695399971},
  {2.56118897929164, 3.4829724482291},
  {2.57023223543133, 3.50558058857834},
  {2.57911683795454, 3.52779209488635},
  {2.58784692565126, 3.54961731412814},
  {2.59642649459458, 3.57106623648646},
  {2.60614174702522, 3.59228349405043},
  {2.61661935933856, 3.61323871867712},
  {2.62692087732731, 3.63384175465462},
  {2.63705070334958, 3.65410140669917},
  {2.64701309423099, 3.67402618846199},
  {2.6568121672291 , 3.6936243344582},
  {2.66645190570691, 3.71290381141382},
  {2.6770451183455 , 3.72939349112733},
  {2.68812106509104, 3.74416142012139},
  {2.69902120315809, 3.75869493754411},
  {2.70974968550754, 3.77299958067672},
  {2.72031053532028, 3.78708071376037},
  {2.7307076510274 , 3.8009435347032},
  {2.74094481110825, 3.81459308147767},
  {2.75102567866879, 3.82803423822505},
  {2.76114809958821, 3.84137771950585},
  {2.77291891588203, 3.85550269905843},
  {2.78451404835057, 3.86941685802068},
  {2.79593740107884, 3.88312488129461},
  {2.80719276332581, 3.89663131599097},
  {2.81828381371516, 3.90994057645819},
  {2.82921412424379, 3.92305694909255},
  {2.83998716411734, 3.9359845969408},
  {2.85060630342126, 3.94872756410551},
  {2.86150474329007, 3.96053740831788},
  {2.87595424040305, 3.96569794300109},
  {2.89020164664732, 3.97078630237404},
  {2.90425117224931, 3.97580399008904},
  {2.91810691129127, 3.98075246831831},
  {2.93177284568882, 3.98563315917458},
  {2.94525284900613, 3.99044744607362},
  {2.95855069011644, 3.99519667504159},
  {2.97167003671522, 3.99988215596972},
  {2.98461445869267, 4.00450516381881},
  {2.99738743137241, 4.00906693977586},
  {3.01383554578452, 4.01},
  {3.03106035116652, 4.01},
  {3.04806145777733, 4.01},
  {3.06484319527057, 4.01},
  {3.08140978228314, 4.01},
  {3.0977653299707 , 4.01},
  {3.11391384540906, 4.01},
  {3.12985923486706, 4.01},
  {3.14560530695683, 4.01},
  {3.16115577566661, 4.01},
  {3.1765142632812 , 4.01},
  {3.191684303195  , 4.01},
  {3.20666934262205, 4.01},
  {3.21473478373645, 4.00704076016472},
  {3.22077051797097, 4.00326842626814},
},
// Cu
{
  {1.27917563431731 , 1.93164873136539 },
  {1.26860602869554 , 1.95402702821289},
  {1.248861392655   , 2.01106708788557},
  {1.22911675661445 , 2.06810714755825},
  {1.20937212057391 , 2.12514720723092},
  {1.18962748453337 , 2.1821872669036},
  {1.18             , 2.21},
  {1.18             , 2.21},
  {1.18             , 2.21},
  {1.18             , 2.21},
  {1.18             , 2.21},
  {1.17941292049189 , 2.2188061926217},
  {1.17771909617534 , 2.24421355736983},
  {1.1760252718588  , 2.26962092211796},
  {1.17433144754226 , 2.29502828686609},
  {1.17263762322572 , 2.32043565161421},
  {1.17094379890918 , 2.34584301636234},
  {1.16869994128009 , 2.36910041103934},
  {1.16576394597769 , 2.38965237815619},
  {1.16282795067528 , 2.41020434527305},
  {1.15989195537287 , 2.4307563123899},
  {1.15695596007046 , 2.45130827950675},
  {1.15401996476806 , 2.47186024662361},
  {1.15108396946565 , 2.49241221374046},
  {1.14761884389863 , 2.50793718700456},
  {1.14384402446083 , 2.5205199184639},
  {1.14006920502303 , 2.53310264992325},
  {1.13629438558522 , 2.54568538138259},
  {1.13251956614742 , 2.55826811284194},
  {1.12874474670962 , 2.57085084430128},
  {1.12496992727181 , 2.58343357576063},
  {1.12119510783401 , 2.59601630721997},
  {1.10782957125685 , 2.59847869640711},
  {1.09002092515916 , 2.5962526156449},
  {1.07221227906148 , 2.59402653488269},
  {1.0544036329638  , 2.59180045412048},
  {1.03164997347047 , 2.59039018815559},
  {0.987978286600547, 2.59243092118689},
  {0.944306599730623, 2.5944716542182},
  {0.900634912860699, 2.5965123872495},
  {0.856963225990776, 2.5985531202808},
  {0.806589879266656, 2.61138582501118},
  {0.739888433447607, 2.65051237144135},
  {0.673186987628558, 2.68963891787152},
  {0.606485541809509, 2.72876546430168},
  {0.53978409599046 , 2.76789201073185},
  {0.473082650171411, 2.80701855716202},
  {0.43733080388902 , 2.87728446085572},
  {0.404131847284799, 2.95011890646702},
  {0.370932890680578, 3.02295335207832},
  {0.337733934076357, 3.09578779768962},
  {0.304534977472136, 3.16862224330093},
  {0.271822227671182, 3.24131796726537},
  {0.262933611230307, 3.30721633053393},
  {0.254044994789432, 3.37311469380249},
  {0.245156378348556, 3.43901305707105},
  {0.236267761907681, 3.50491142033961},
  {0.227379145466806, 3.57080978360817},
  {0.21849052902593 , 3.63670814687672},
  {0.214140281242912, 3.69665343615332},
  {0.214423792243139, 3.75052052619642},
  {0.214707303243366, 3.80438761623951},
  {0.214990814243593, 3.8582547062826},
  {0.214480232058444, 3.90937795444779},
  {0.213943059733563, 3.96040932531156},
  {0.213405887408681, 4.01144069617533},
  {0.213062096651253, 4.06179836373799},
  {0.213316174602368, 4.11007317444992},
  {0.213570252553483, 4.15834798516185},
  {0.213824330504599, 4.20662279587377},
  {0.214666458703268, 4.25406968373566},
  {0.216826078610165, 4.29966165954792},
  {0.218985698517061, 4.34525363536018},
  {0.221145318423957, 4.39084561117243},
  {0.223268637069489, 4.43602618291015},
  {0.225171165890229, 4.47870453213217},
  {0.22707369471097 , 4.52138288135419},
  {0.228976223531711, 4.56406123057621},
  {0.230878752352451, 4.60673957979823},
  {0.232781281173192, 4.64941792902025},
  {0.234683809993932, 4.69209627824227},
  {0.236586338814673, 4.73477462746429},
  {0.238488867635414, 4.77745297668631},
  {0.240391396456154, 4.82013132590833},
  {0.242293925276895, 4.86280967513035},
  {0.244196454097636, 4.90548802435237},
  {0.246098982918376, 4.94816637357439},
  {0.248001511739117, 4.99084472279641},
  {0.249904040559858, 5.03352307201843},
  {0.251806569380598, 5.07620142124045},
  {0.253709098201339, 5.11887977046247},
  {0.25561162702208 , 5.16155811968449},
  {0.25751415584282 , 5.20423646890651},
  {0.259416684663561, 5.24691481812853},
  {0.261451340174754, 5.28684559860816},
},
{// Fe
{1.59610561007822, 2.30763201259777},
{1.60887362195247, 2.32359202744059},
{1.62164163382672, 2.3395520422834},
{1.63440964570097, 2.35551205712621},
{1.64717765757522, 2.37147207196903},
{1.65994566944947, 2.38743208681184},
{1.67271368132372, 2.40339210165465},
{1.68548169319797, 2.41935211649747},
{1.69824970507223, 2.43531213134028},
{1.71101771694648, 2.4512721461831},
{1.72378572882073, 2.46723216102591},
{1.73655374069498, 2.48319217586872},
{1.74932175256923, 2.49915219071154},
{1.76208976444348, 2.51511220555435},
{1.77485777631773, 2.53107222039716},
{1.78762578819198, 2.54703223523998},
{1.80039380006623, 2.56299225008279},
{1.81316181194049, 2.57895226492561},
{1.82592982381474, 2.59491227976842},
{1.83869783568899, 2.61087229461123},
{1.85146584756324, 2.62683230945405},
{1.86423385943749, 2.64279232429686},
{1.87700187131174, 2.65875233913968},
{1.88976988318599, 2.67471235398249},
{1.90253789506024, 2.6906723688253},
{1.91530590693449, 2.70663238366812},
{1.92807391880874, 2.72259239851093},
{1.940841930683  , 2.73855241335374},
{1.95360994255725, 2.75451242819656},
{1.9663779544315 , 2.77047244303937},
{1.97914596630575, 2.78643245788219},
{1.99191397818   , 2.802392472725},
{2.00468199005425, 2.81835248756781},
{2.0174500019285 , 2.83431250241063},
{2.03021801380275, 2.85027251725344},
{2.042986025677  , 2.86623253209625},
{2.05575403755125, 2.88219254693907},
{2.06852204942551, 2.89815256178188},
{2.08129006129976, 2.9141125766247},
{2.09405807317401, 2.93007259146751},
{2.10682608504826, 2.94603260631032},
{2.11959409692251, 2.96199262115314},
{2.13236210879676, 2.97795263599595},
{2.14513012067101, 2.99391265083877},
{2.15789813254526, 3.00987266568158},
{2.17066614441951, 3.02583268052439},
{2.18343415629377, 3.04179269536721},
{2.19620216816802, 3.05775271021002},
{2.20897018004227, 3.07371272505283},
{2.22173819191652, 3.08967273989565},
{2.23450620379077, 3.10563275473846},
{2.24727421566502, 3.12159276958128},
{2.26004222753927, 3.13755278442409},
{2.27281023941352, 3.1535127992669},
{2.28557825128777, 3.16947281410972},
{2.29834626316202, 3.18543282895253},
{2.31111427503628, 3.20139284379534},
{2.32388228691053, 3.21735285863816},
{2.33665029878478, 3.23331287348097},
{2.34941831065903, 3.24927288832379},
{2.36218632253328, 3.2652329031666},
{2.37495433440753, 3.28119291800941},
{2.38772234628178, 3.29715293285223},
{2.40049035815603, 3.31311294769504},
{2.41325837003028, 3.32907296253785},
{2.42602638190453, 3.34503297738067},
{2.43879439377879, 3.36099299222348},
{2.45156240565304, 3.3769530070663},
{2.46433041752729, 3.39291302190911},
{2.47709842940154, 3.40887303675192},
{2.48986644127579, 3.42483305159474},
{2.50263445315004, 3.44079306643755},
{2.51540246502429, 3.45675308128037},
{2.52817047689854, 3.47271309612318},
{2.54093848877279, 3.48867311096599},
{2.55370650064705, 3.50463312580881},
{2.5664745125213 , 3.52059314065162},
{2.57924252439555, 3.53655315549443},
{2.5920105362698 , 3.55251317033725},
{2.60477854814405, 3.56847318518006},
{2.6175465600183 , 3.58443320002288},
{2.63031457189255, 3.60039321486569},
{2.6430825837668 , 3.6163532297085},
{2.65585059564105, 3.63231324455132},
{2.66861860751531, 3.64827325939413},
{2.68138661938956, 3.66423327423694},
{2.69415463126381, 3.68019328907976},
{2.70692264313806, 3.69615330392257},
{2.71969065501231, 3.71211331876539},
{2.73245866688656, 3.7280733336082},
{2.74522667876081, 3.74403334845101},
{2.75799469063506, 3.75999336329383},
{2.77076270250931, 3.77595337813664},
{2.78353071438356, 3.79191339297945},
{2.79629872625782, 3.80787340782227},
},
{  // Au
{1.72670531771933 , 1.85575523133039},
{1.71536108597285 , 1.86340561085973},
{1.70631131221719 , 1.88331511312217},
{1.69726153846154 , 1.90322461538462},
{1.68793714334384 , 1.91699480453113},
{1.67856826505408 , 1.92977054765352},
{1.67071985276466 , 1.94010018404417},
{1.66431831639593 , 1.94810210450508},
{1.65789273927393 , 1.9560097509751},
{1.64964191419142 , 1.9567598259826},
{1.64139108910891 , 1.9575099009901},
{1.63356771929825 , 1.95581094736842},
{1.6265501754386  , 1.94949515789474},
{1.61953263157895 , 1.94317936842105},
{1.60721867836794 , 1.93414578557862},
{1.58953579147292 , 1.92235719431528},
{1.5718529045779  , 1.91056860305194},
{1.54363888041954 , 1.89616952253186},
{1.50217293737423 , 1.8784855174096},
{1.46070699432892 , 1.86080151228733},
{1.41750897457675 , 1.84369265613499},
{1.36541679406602 , 1.82953717230055},
{1.31332461355529 , 1.81538168846611},
{1.26123243304456 , 1.80122620463167},
{1.18809394987942 , 1.80327566320646},
{1.10263730732935 , 1.81480968858131},
{1.01718066477928 , 1.82634371395617},
{0.931724022229213, 1.83787773933103},
{0.855184048782849, 1.89528722837923},
{0.780654696801045, 1.96304118472632},
{0.706125344819242, 2.03079514107342},
{0.631595992837439, 2.09854909742051},
{0.576661145986376, 2.18389475090156},
{0.530803882284849, 2.27739014291439},
{0.484946618583322, 2.37088553492721},
{0.439089354881795, 2.46438092694003},
{0.398254193706379, 2.55326639728991},
{0.378663156605853, 2.62265132035427},
{0.359072119505326, 2.69203624341864},
{0.3394810824048  , 2.761421166483},
{0.319890045304273, 2.83080608954737},
{0.303710747238174, 2.88441498746923},
{0.295843899259392, 2.89958676571403},
{0.28797705128061 , 2.91475854395882},
{0.280110203301828, 2.92993032220362},
{0.272243355323046, 2.94510210044841},
{0.264376507344264, 2.9602738786932},
{0.256509659365482, 2.975445656938},
{0.2486428113867  , 2.99061743518279},
{0.240775963407918, 3.00578921342759},
{0.232909115429137, 3.02096099167238},
{0.225042267450354, 3.03613276991717},
{0.217175419471573, 3.05130454816197},
{0.209308571492791, 3.06647632640676},
{0.201441723514009, 3.08164810465155},
{0.193574875535227, 3.09681988289635},
{0.185708027556445, 3.11199166114114},
{0.177841179577663, 3.12716343938594},
{0.169974331598881, 3.14233521763073},
{0.165590532936114, 3.194358931921},
{0.164762992386627, 3.28400915811541},
{0.16393545183714 , 3.37365938430983},
{0.163107911287653, 3.46330961050425},
{0.162280370738166, 3.55295983669866},
{0.161452830188679, 3.64261006289308},
{0.160625289639192, 3.7322602890875},
{0.160120643696318, 3.81658850824366},
{0.160614275841643, 3.88446292822589},
{0.161107907986968, 3.95233734820811},
{0.161601540132293, 4.02021176819034},
{0.162095172277619, 4.08808618817257},
{0.162588804422944, 4.1559606081548},
{0.163082436568269, 4.22383502813703},
{0.163576068713595, 4.29170944811926},
{0.164154889098528, 4.35789934402492},
{0.165251837388386, 4.41384370680766},
{0.166348785678243, 4.4697880695904},
{0.167445733968101, 4.52573243237314},
{0.168542682257958, 4.58167679515588},
{0.169639630547816, 4.63762115793862},
{0.170736578837674, 4.69356552072135},
{0.171833527127531, 4.74950988350409},
{0.172930475417389, 4.80545424628683},
{0.174033876650277, 4.86128247318905},
{0.17538894266135 , 4.91258140075109},
{0.176744008672422, 4.96388032831314},
{0.178099074683495, 5.01517925587518},
{0.179454140694568, 5.06647818343722},
{0.180809206705641, 5.11777711099926},
{0.182164272716714, 5.16907603856131},
{0.183519338727787, 5.22037496612335},
{0.184874404738859, 5.27167389368539},
{0.186229470749932, 5.32297282124743},
{0.187584536761005, 5.37427174880948},
{0.189291947559199, 5.41877519563671},
},
{  // Ag
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.197f , 1.721f},
{ 0.193f , 1.780f},
{ 0.188f , 1.838f},
{ 0.180f , 1.894f},
{ 0.173f , 1.950f},
{ 0.173f , 2.010f},
{ 0.173f , 2.070f},
{ 0.171f , 2.127f},
{ 0.166f , 2.180f},
{ 0.162f , 2.233f},
{ 0.159f , 2.282f},
{ 0.158f , 2.328f},
{ 0.157f , 2.374f},
{ 0.155f , 2.421f},
{ 0.151f , 2.470f},
{ 0.147f , 2.519f},
{ 0.143f , 2.567f},
{ 0.140f , 2.612f},
{ 0.136f , 2.657f},
{ 0.133f , 2.702f},
{ 0.131f , 2.746f},
{ 0.131f , 2.788f},
{ 0.130f , 2.830f},
{ 0.130f , 2.872f},
{ 0.130f , 2.917f},
{ 0.130f , 2.963f},
{ 0.130f , 3.009f},
{ 0.130f , 3.055f},
{ 0.129f , 3.097f},
{ 0.129f , 3.137f},
{ 0.129f , 3.177f},
{ 0.129f , 3.217f},
{ 0.128f , 3.257f},
{ 0.126f , 3.298f},
{ 0.124f , 3.338f},
{ 0.123f , 3.379f},
{ 0.121f , 3.420f},
{ 0.120f , 3.460f},
{ 0.120f , 3.500f},
{ 0.120f , 3.539f},
{ 0.120f , 3.578f},
{ 0.120f , 3.617f},
{ 0.120f , 3.656f},
{ 0.122f , 3.694f},
{ 0.124f , 3.731f},
{ 0.125f , 3.768f},
{ 0.127f , 3.806f},
{ 0.129f , 3.843f},
{ 0.131f , 3.880f},
{ 0.132f , 3.922f},
{ 0.133f , 3.963f},
{ 0.135f , 4.004f},
{ 0.136f , 4.045f},
{ 0.137f , 4.087f},
{ 0.139f , 4.128f},
{ 0.140f , 4.169f},
{ 0.140f , 4.209f},
{ 0.140f , 4.249f},
{ 0.140f , 4.289f},
{ 0.140f , 4.329f},
{ 0.140f , 4.369f},
{ 0.140f , 4.409f},
{ 0.140f , 4.448f},
{ 0.141f , 4.485f},
{ 0.142f , 4.522f},
{ 0.143f , 4.560f},
{ 0.144f , 4.597f},
{ 0.145f , 4.634f},
{ 0.146f , 4.671f},
{ 0.147f , 4.708f},
{ 0.147f , 4.745f},
{ 0.147f , 4.783f},
{ 0.146f , 4.822f},
{ 0.146f , 4.86f},
{ 0.145f , 4.898f},
{ 0.145f , 4.937f},
{ 0.144f , 4.975f},
{ 0.144f , 5.014f},
{ 0.143f , 5.052f},
{ 0.143f , 5.090f},
{ 0.143f , 5.130f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
{ 0.000f , 0.000f},
},
}; 

#ifndef __cplusplus
static inline void fresnel_get_ior_mf(const int mat, const mf_t lambda, mf_t *n, mf_t *k)
{
  float nf[MF_COUNT], kf[MF_COUNT];
  const float *lf = (const float *)&lambda;
  for(int l=0;l<MF_COUNT;l++)
  {
    const int i = CLAMP((lf[l] - 360.0f)/5.0f, 0, 94);
    nf[l] =   fresnel_ior[mat][i][0];
    kf[l] = - fresnel_ior[mat][i][1];
  }
  *n = mf_loadu(nf);
  *k = mf_loadu(kf);
}

static inline complex float fresnel_get_ior(const int mat, const float lambda)
{
  const int i = CLAMP((lambda - 360.0f)/5.0f, 0, 94);
  assert(mat < s_ior_num_materials && mat >= 0);
  // complex ior is eta - i*kappa
  return fresnel_ior[mat][i][0] - I*fresnel_ior[mat][i][1];
}
#else
static inline std::complex<float> fresnel_get_ior(const int mat, const float lambda)
{
  const int i = CLAMP((lambda - 360.0f)/5.0f, 0, 94);
  assert(mat < s_ior_num_materials && mat >= 0);
  // complex ior is eta - i*kappa
  return std::complex<float>(fresnel_ior[mat][i][0], - fresnel_ior[mat][i][1]);
}
#endif

static inline int fresnel_get_material(const char *mat)
{
  for(int i=0;i<s_ior_num_materials;i++)
  {
    if(!strcasecmp(mat, fresnel_ior_material[i]))
      return i;
  }
  return -1;
}

